name: Continuous integration

on:
  push:
    branches: ["main"]
  pull_request:
    types: [opened, synchronize, reopened, closed]
    branches: ["main"]

jobs:
  client_test_job:
    name: Client test
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"
          cache-dependency-path: client/package-lock.json

      - name: Install client dependencies
        run: npm clean-install --prefix=client

      - name: Lint client
        run: npm run lint --prefix=client

      - name: Build client
        run: npm run build --prefix=client

      - name: Test client (with coverage)
        run: npm run test:coverage --prefix=client

      - name: Report Coverage
        if: always()
        uses: davelosert/vitest-coverage-report-action@v2
        with:
          json-summary-path: "./client/coverage/coverage-summary.json"
          json-final-path: "./client/coverage/coverage-final.json"


  # ============================
  # Server (.NET) – build & test
  # ============================
  server_test_job:
    name: Server test
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: client_test_job   # серверні тести запускаються після клієнта

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          # Backend targets net9.0
          dotnet-version: "9.0.x"

      - name: Restore .NET solution
        run: dotnet restore DeadPigeons.sln

      - name: Build backend
        run: dotnet build DeadPigeons.sln --no-restore

      - name: Test backend
        run: dotnet test DeadPigeons.sln --no-build

  # ============================
  # End-to-end tests (Playwright + Docker) — пізніше
  # ============================
  # e2e_test_job:
  #   name: End-to-end test
  #   runs-on: ubuntu-latest
  #   needs: [client_test_job, server_test_job]
  #   timeout-minutes: 15
  #
  #   steps:
  #     - name: Checkout repository
  #       uses: actions/checkout@v4
  #
  #     - name: Setup Node.js
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: "22"
  #         cache: "npm"
  #         cache-dependency-path: client/package-lock.json
  #
  #     - name: Setup Docker Buildx
  #       uses: docker/setup-buildx-action@v3
  #
  #     - name: Start services (API + DB)
  #       run: docker compose up -d --wait
  #
  #     - name: Install client dependencies for e2e
  #       run: npm clean-install --prefix=client
  #
  #     - name: Install Playwright browsers
  #       run: npx --prefix=client playwright install --with-deps
  #
  #     - name: Run e2e tests
  #       run: npm run e2e --prefix=client
  #
  #     - name: Stop services
  #       if: always()
  #       run: docker compose down
